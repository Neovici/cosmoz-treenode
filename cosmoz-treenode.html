<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../cosmoz-tree/cosmoz-tree.html">

<!--
`cosmoz-treenode` is a component to display a node in a `cosmoz-tree` data structure

@demo demo/index.html
-->
<dom-module id="cosmoz-treenode">
	<template>
		<style>
			:host {
				display: block;
			}

			:host([no-wrap]) {
				white-space: nowrap;
				overflow: hidden;
				text-overflow: ellipsis;
			}
		</style>
		<span>[[ _pathText ]]</span>
	</template>
	<script>
		Polymer({
			is: 'cosmoz-treenode',

			properties: {

				/**
				 * Name of the property used to lookup the displayed node in the tree
				 */
				keyProperty: {
					type: String,
				},

				/**
				 * The value for the `keyProperty` used to lookup the node in the tree.
				 */
				keyValue: {
					type: String
				},

				ownerTree: {
					type: Cosmoz.Tree
				},

				valueProperty: {
					type: String,
					value: 'name'
				},

				pathSeparator: {
					type: String,
					value: ' / '
				},

				/**
				 * Represent a number of nodes that should not be rendered starting from root.
				 * If the path to the displayed node has less nodes than this number, then nothing is hidden.
				 */
				hideFromRoot: {
					type: Number,
					value: 0
				},

				showMaxNodes: {
					type: Number,
					value: 0
				},

				ellipsis: {
					type: String,
					value: 'â€¦ / '
				},

				noWrap: {
					type: Boolean,
					reflectToAttribute: true
				},

				_path: {
					type: Array,
					computed: '_computePath(ownerTree, keyProperty, keyValue)'
				},

				_pathToRender: {
					type: Array,
					computed: '_computePathToRender(_path, hideFromRoot, showMaxNodes)'
				},

				_pathText: {
					type: String,
					computed: '_computePathText(_pathToRender, valueProperty, pathSeparator)'
				},

			},

			_computePathToRender: function (path, hideFromRoot, showMaxNode) {
				var pathToRender = path;
				if (hideFromRoot > 0 && path.length > hideFromRoot) {
					pathToRender = path.slice(hideFromRoot);
				}

				if (showMaxNode > 0 && pathToRender.length > showMaxNode) {
					pathToRender = path.slice(-showMaxNode);
				}

				return pathToRender;
			},

			_computePath: function (ownerTree, keyProperty, keyValue) {
				// HACK(pasleq): Cosmoz.Tree API needs to be fixed to avoid such code in components

				var path = null,
					node,
					i;
				if (!ownerTree) {
					return;
				}

				if (keyProperty === 'pathLocator') {
					path = ownerTree.getPathNodes(keyValue);
				} else {
					node = ownerTree.getNodeByProperty(keyValue, keyProperty);
					if (node && node.pathLocator) {
						path = ownerTree.getPathNodes(node.pathLocator);
					}
				}
				if (path !== null && path.length) {
					for (i = path.length - 1; i >= 0; i--) {
						if (path[i] === undefined) {
							path.splice(0, i + 1);
							if (path.length === 0) {
								path = null;
							}
							break;
						}
					}
				}

				return path;
			},

			_computePathText: function (pathToRender, valueProperty, pathSeparator) {
				var text = pathToRender.map(function (node) {
					return this.ownerTree.getProperty(node, valueProperty);
				}, this).join(pathSeparator);

				if (pathToRender.length < this._path.length) {
					text = this.ellipsis + text;
				}

				return text;
			},
		});
	</script>
</dom-module>
